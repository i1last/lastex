%========================================================================================
% КЛАСС ДОКУМЕНТА И ОСНОВНЫЕ ПАРАМЕТРЫ
%========================================================================================
\documentclass[a4paper,14pt,russian]{extarticle}

% Расширяет возможности размеров стандартных классов
\usepackage{extsizes}





%========================================================================================
% ТИПОГРАФИКА И МИКРО-НАСТРОЙКИ
%========================================================================================
% Пакет microtype улучшает разбивку на строки и общую "серость" текста,
% что позволяет избежать больших пробелов между словами. Это замена для \sloppy.
\usepackage{microtype}





%========================================================================================
% ЯЗЫК, ШРИФТЫ И КОДИРОВКА (Современный подход для LuaLaTeX)
%========================================================================================
\usepackage{fontspec}       % Пакет для работы с любыми системными шрифтами.
                            % Заменяет устаревшие inputenc и fontenc.
\usepackage[russian]{babel} % Поддержка русского языка: переносы, названия и т.д.
\usepackage{bm}             % Жирный шрифт для математических символов

% --- Настройка шрифтов и интервалов
% Явно определяем семейство шрифтов "Times New Roman", указывая путь к файлам
\setmainfont{Times New Roman}[
    Path            = /usr/local/share/fonts/truetype/times-new-roman/, % Путь внутри контейнера
    Extension       = .ttf,
    UprightFont     = times,
    BoldFont        = timesbd,
    ItalicFont      = timesi,
    BoldItalicFont  = timesbi
]
% \setmainfont{TeX Gyre Termes} % Свободный аналог Times New Roman, включенный в TeX Live

% --- Настройка моноширинного шрифта для кода ---
\setmonofont{JetBrains Mono}[
    Path            = /usr/local/share/fonts/truetype/jb-mono/, % Путь внутри контейнера
    Extension       = .ttf,
    UprightFont     = JetBrainsMono-Regular,
    BoldFont        = JetBrainsMono-Bold,
    ItalicFont      = JetBrainsMono-Italic,
    BoldItalicFont  = JetBrainsMono-BoldItalic
]

% Указываем babel использовать основной шрифт для всех языков по умолчанию
\babelprovide[main]{russian}


\usepackage{setspace}         % Пакет для гибкого управления интервалами
\onehalfspacing               % Установка полуторного межстрочного интервала





%========================================================================================
% СТРАНИЦЫ
%========================================================================================
\usepackage[left=3cm, right=1cm, top=2cm, bottom=2cm]{geometry} % Поля документа
\usepackage{indentfirst}        % Красная строка для первого абзаца после заголовка
\setlength{\parindent}{1.25cm}  % Отступ красной строки - 1.25 см

\usepackage{pdflscape}          % Поддержка горизонтальных страниц

% --- Поддержка колонтитулов
\usepackage{enotez}

\makeatletter % Создание нового стиля для сносок на странице
\def\enotez@endnotes@footer{%
    \begin{center}
        \rule{0.5\linewidth}{0.4pt}
        \enotez@theendnotes
    \end{center}
}

% --- Настройка содержанмя
\usepackage{tocloft}

% --- Для настроек по умолчанию закоментированы 1 и 2
% -- 1 Устанавливаем пробелы между заголовком и номером страницы
% \renewcommand{\cftsecleader      }{\hfil}
% \renewcommand{\cftsubsecleader   }{\hfil}
% \renewcommand{\cftsubsubsecleader}{\hfil}
% -- 2 Устанавливаем точки между заголовком и номером страницы
\renewcommand{\cftsecleader      }{\cftdotfill{\cftdotsep}}
\renewcommand{\cftsubsecleader   }{\cftdotfill{\cftdotsep}}
\renewcommand{\cftsubsubsecleader}{\cftdotfill{\cftdotsep}}
% -- Форматирование заголовка Содержания
\renewcommand{\cfttoctitlefont}{\normalfont\normalsize\bfseries\centering\uppercase}
% -- Меняем название на "СОДЕРЖАНИЕ"
\renewcommand{\contentsname}{СОДЕРЖАНИЕ}
% -- Убираем жирный шрифт с разделов и номеров страниц
\renewcommand{\cftsecfont       }{\normalfont} 
\renewcommand{\cftsecpagefont   }{\normalfont}
\renewcommand{\cftsubsecfont    }{\normalfont}
\renewcommand{\cftsubsecpagefont}{\normalfont}

% --- Вертикальные отступы в содержании
% \setlength{\cftaftertoctitleskip}{1em}  % Отступ ПОСЛЕ заголовка "СОДЕРЖАНИЕ"
\setlength{\cftbeforesecskip      }{0.3em}
\setlength{\cftbeforesubsecskip   }{0.2em}
\setlength{\cftbeforesubsubsecskip}{0.21em}





%========================================================================================
% ЗАГОЛОВКИ
%========================================================================================
\usepackage{titlesec}

% --- Настройка формматирования заголовков
%titleformat{<команда>     }{<стиль>             }{<номер>           }{<отступ>}{<текст до>}
\titleformat{\section      }{\bfseries\normalsize}{\thesection       }{0.25em     }{          }
\titleformat{\subsection   }{\bfseries\normalsize}{\thesubsection    }{0.25em     }{          }
\titleformat{\subsubsection}{\bfseries\normalsize}{\thesubsubsection }{0.25em     }{          }

% --- Настройка отступов для создания иерархии ---
%titlespacing*{<команда>     }{<отступ слева>}{<отступ сверху> }{<отступ снизу>  }
\titlespacing*{\section      }{1.0\parindent }{1.2\baselineskip}{0.5\baselineskip} % Раздел: без отступа слева
\titlespacing*{\subsection   }{1.0\parindent }{1.0\baselineskip}{0.5\baselineskip} % Подраздел: отступ слева равен абзацному отступу (\parindent)
\titlespacing*{\subsubsection}{1.0\parindent }{1.0\baselineskip}{0.5\baselineskip} % Подподраздел: отступ слева равен двум абзацным отступам

%  --- Добавление центрального заголовка без номера
\newcommand{\centeredsection}[1]{
    \noindent
    \begin{center}
        \textbf{\normalsize #1}
    \end{center}
    \par
}





%========================================================================================
% ПРИЛОЖЕНИЯ
%========================================================================================
\usepackage{appendix}
\usepackage{etoolbox} % Пакет для надежного изменения команд

\usepackage{xurl} 
\usepackage{hyperref} % Для работы \phantomsection

% Переопределяем стандартные названия на русские
\renewcommand{\appendixname}{Приложение}
\renewcommand{\appendixtocname}{Приложения}

% Этот код сработает автоматически, как только вы напишете \begin{appendices}
\AtBeginEnvironment{appendices}{%
    % Меняем нумерацию секций на русские буквы (А, Б, В...)
    % \renewcommand{\thesection}{\asbuk{section}}
    
    \renewcommand{\section}[1]{%
        \clearpage
        
        \refstepcounter{section}
        
        % Добавляем в Содержание РОВНО ОДНУ строку
        % Формат: "Приложение А. Тема приложения"
        \addcontentsline{toc}{section}{\appendixname~\thesection. #1}
        
        % Вручную создаем заголовок на странице
        \begin{center}
            \textbf{\MakeUppercase{\appendixname}~\thesection} % Первая строка: "ПРИЛОЖЕНИЕ А"
            \par
            \textbf{#1} % Вторая строка: "Тема приложения"
        \end{center}
        
        % Добавляем невидимую метку для правильной работы гиперссылок
        \phantomsection
    }
}

% ИСПОЛЬЗОВАНИЕ:
    % % --- НАЧАЛО ПРИЛОЖЕНИЙ ---
    % \begin{appendices}

    % % Каждое приложение - это обычная \section
    % \section{Тема первого приложения}
    % Здесь содержимое приложения А.
    % Оно будет на новой странице.

    % \section{Тема второго приложения}
    % Здесь содержимое приложения Б.
    % Оно также будет на новой странице.

    % \end{appendices}
    % % --- КОНЕЦ ПРИЛОЖЕНИЙ ---





%========================================================================================
% МАТЕМАТИКА
%========================================================================================
\usepackage{amsmath}        % Основные математические окружения
\usepackage{amsfonts}       % Математические шрифты
\usepackage{amssymb}        % Дополнительные математические символы
\usepackage{mathtools}      % Расширение для amsmath с исправлением ошибок и новыми командами
\usepackage{icomma}         % Корректная работа запятой как десятичного разделителя в формулах

% Требования к оформлению устанавливают, что длинные формулы должны переноситься на следующую строку
% с выравниванием. Для этого используется окружение align:
% Знак умножения "x" в LaTeX - это \times
% \begin{align*}
%     C_1+C_2+C_3+C_4 &= A_1 \cdot A_2 \cdot A_3 \times \\
%     &\quad \times (A_1+B_1) \cdot (A_2+B_2) \cdot (B_1+B_2)
% \end{align*}
% &=:            Выравнивание по знаку равенства.
% \\:            Перенос строки.
% &\quad \times: Выравнивание второй строки по знаку & из первой, \quad добавляет отступ, а \times повторяет знак умножения.





%========================================================================================
% ГРАФИКА, ТАБЛИЦЫ И ПЛАВАЮЩИЕ ОБЪЕКТЫ
%========================================================================================
\usepackage{graphicx}       % Для вставки изображений
\usepackage{float}          % Для точного позиционирования объектов с опцией [H]
\usepackage{caption}        % Гибкая настройка подписей к рисункам и таблицам
\usepackage{subcaption}     % Подписи для подрисунков и подтаблиц

% --- Настройка подписей к рисункам
\captionsetup[figure]{
    position=bottom,           % Подпись под рисунком
    justification=centering,   % Выравнивание по центру
    labelsep=endash,           % Разделитель "Рисунок 1 –" (тире)
    singlelinecheck=false,     % Принудительное центрирование даже для коротких подписей
    font=normalsize,           % Обычный размер шрифта (не курсив)
    skip=6pt                   % Отступ после подписи
}

% --- Настройка подписей к таблицам
\captionsetup[table]{
    position=top,              % Подпись над таблицей
    justification=raggedright, % Выравнивание по левому краю
    labelsep=endash,           % Разделитель "Таблица 1 –" (тире)
    singlelinecheck=false,     % Принудительное выравнивание по левому краю
    font=normalsize,           % Обычный размер шрифта (не курсив)
    skip=6pt                   % Отступ перед таблицей
}

% --- Настройка отступов для плавающих объектов ---
% Отступ сверху и снизу для объектов, расположенных внутри текста.
\setlength{\intextsep}{6pt} 
% Отступ сверху и снизу для объектов, расположенных вверху или внизу страницы.
\setlength{\textfloatsep}{6pt}



% --- Настройка таблиц ---
\usepackage{tabularray}
\UseTblrLibrary{booktabs}

% Настройки
\DeclareTblrTemplate{middlehead,lasthead}{default}{
    \UseTblrTemplate{conthead}{default}
}
\DefTblrTemplate{caption}{default}{
    \raggedright
    \parindent=0pt
    \UseTblrTemplate{caption-tag}{}{Таблица~\thetable}
    \UseTblrTemplate{caption-sep}{}{--}
    \UseTblrTemplate{caption-text}{default}
}

\DeclareTblrTemplate{contfoot-text}{normal}{\textit{Продолжение на следующей странице}}
\DeclareTblrTemplate{conthead-text}{normal}{\textit{Продолжение табл. \thetable}}
\SetTblrTemplate{contfoot-text}{normal}
\SetTblrTemplate{conthead-text}{normal}

% --- Глобальный стиль ---
\NewTblrTheme{mytable}{
  \SetTblrInner[
    caption = {template = my-caption},
    caption-pos = t,
    caption-skip = 6pt,
    conthead-text = default
  ]
}


% === ВНИМАНИЕ! Последующие настройки таблиц нужны для сохранения
% === обратной совместимости. В реальность используется tabularray
% === выше.

% --- Пакеты для качественных таблиц
\usepackage{multirow}       % Улучшенное форматирование таблиц
\usepackage{tabularx}       % Таблицы с автоматическим расчетом ширины колонок
\usepackage{longtable}      % Таблицы, которые могут переноситься на несколько страниц
\usepackage{array}          % Расширяет возможности работы с таблицами и выравниваниями
\usepackage{booktabs}       % Профессиональное оформление таблиц (горизонтальные линии \toprule, \midrule, \bottomrule)
\usepackage{makecell}       % Многострочные ячейки в таблицах

% --- Настройка новых типов колонок для tabularx
\renewcommand{\tabularxcolumn}[1]{m{#1}}
\newcolumntype{C}{>{\centering\arraybackslash}X}
\newcolumntype{L}{>{\arraybackslash}X}
\newcolumntype{R}{>{\raggedleft\arraybackslash}X}

% --- Настройка списков для компактного вида ---
\usepackage{enumitem}
% Устанавливаем глобальные параметры для всех списков (itemize, enumerate, description).
% Это убирает излишние вертикальные отступы в списках, не затрагивая основной текст.
\setlist{
    itemsep=2pt,           % Вертикальный отступ между элементами списка
    parsep=0pt,            % Отступ между абзацами внутри одного элемента списка
    topsep=5pt,            % Отступ перед и после всего списка
    leftmargin=\parindent  % Использовать стандартный левый отступ
}





%========================================================================================
% ИСХОДНЫЙ КОД
%========================================================================================
\usepackage[newfloat=true]{minted}       % Для вставки листингов кода
\usepackage{xcolor}
\usepackage{newfloat}


% --- Регистрируем новый тип подписи 'listing' ---
% --- Создание нового окружения для 'listing' ---
\SetupFloatingEnvironment{listing}{
    name=Листинг,
    listname=Список листингов
    placement=hbtp,
}

\captionsetup[listing]{
    position=top,
    justification=raggedleft,  % Выравнивание по правому краю
    labelsep=endash,           % Разделитель "Листинг 1 –" (тире)
    singlelinecheck=false,     % Принудительное выравнивание
    font=normalsize,           % Обычный размер шрифта
    skip=0pt,                  % Отступ после подписи. Значение 0 визуально совпадает со значением 6pt
}

% --- Настройка внешнего вида блоков кода minted ---
% Определяем цвет фона, если он еще не определен
\definecolor{backcolour}{rgb}{0.98,0.98,0.98}

% Переопределяем команду для стилизации номеров строк
% \theFancyVerbLine - это команда, которую minted использует для вывода номера
\renewcommand{\theFancyVerbLine}{
  \tiny\color{gray}\arabic{FancyVerbLine}
}

% --- Автоматический расчет отступа для номеров строк ---
% Этот блок рассчитывает отступ слева, чтобы номера строк (до 999) не
% прилипали к коду. Для 1000+ строк может понадобиться увеличить '999'.
\newlength{\mintednumbersep}
\setlength{\mintednumbersep}{8pt}
\newlength{\mintedxleftmargin}
\settowidth{\mintedxleftmargin}{{\tiny 999}}
\addtolength{\mintedxleftmargin}{\mintednumbersep}

% --- Глобальные настройки для всех блоков minted ---
% См. fancyvrb документацию для всех доступных опций
\setminted{
    fontfamily=tt,      % Использовать моноширинный шрифт
    fontsize=\footnotesize,
    frame=lines,        % Рамка вокруг кода
    framesep=2mm,       % Отступ от рамки до кода
    rulecolor=\color{black!20},
    bgcolor=backcolour, % Цвет фона
    linenos,            % Включить нумерацию строк
    breaklines,         % Автоматически переносить длинные строки
    tabsize=2,
    vspace=0pt,         % Вертикальные отступы до и после блока кода
    numbersep=\mintednumbersep,      % Используем нашу переменную
    xleftmargin=\mintedxleftmargin   % Используем нашу вычисленную переменную
}

\RenewDocumentCommand{\texttt}{m}{\mintinline{x}§#1§}





%========================================================================================
% ССЫЛКИ И НАВИГАЦИЯ
%========================================================================================
% Внимание! XURL должен загружаться ДО hyperref. Первое включение hyperref 
% в разделе "Приложения"! Включение данного пакета осуществляется там.
% \usepackage{xurl} 
% \usepackage{hyperref}       % Создание кликабельных ссылок в документе
\hypersetup{
    colorlinks=true,
    linkcolor=black,
    urlcolor=blue,
    citecolor=black
}

\renewcommand{\UrlFont}{\footnotesize\ttfamily}

% cleveref ОБЯЗАТЕЛЬНО должен быть загружен ПОСЛЕ hyperref
\usepackage[russian]{cleveref} % "Умные" ссылки (\cref вместо \ref)
% cleveref автоматически подставляет "рис.", "табл.", "формула"
% Было:  Как видно из рис. \ref{fig:graph} и табл. \ref{tab:my_results}... -> Результат: "Как видно из рис. 1 и табл. 1..."
% Стало: Как видно из \cref{fig:graph}     и \cref{tab:my_results}...      -> Результат: "Как видно из рис. 1 и табл. 1..."
% Настраиваем названия для cleveref
% ПРИМЕЧАНИЕ: 
%   1. Требует несколько раз компиляции для правильной работы ссылок.
%   2. Требует вначале \caption, затем \label
\crefname{figure}{рис.}{рис.}
\Crefname{figure}{Рис.}{Рис.}
\crefname{table}{табл.}{табл.}
\Crefname{table}{Табл.}{Табл.}
\crefname{section}{разд.}{разд.}
\Crefname{section}{Разд.}{Разд.}
\crefname{equation}{форм.}{форм.}
\Crefname{equation}{Форм.}{Форм.}
\crefname{listing}{лист.}{лист.}
\Crefname{listing}{Лист.}{Лист.}
